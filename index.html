<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escritorio Remoto - WebRTC</title>
    
    <!-- Firebase (versi√≥n compatible con scripts) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .video-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        video {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        .connection-info {
            background: #f0f8ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
        }

        .connection-info strong {
            color: #667eea;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #3c3;
        }

        .info {
            background: #eef;
            color: #339;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #339;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            .section h2 {
                font-size: 1.1em;
            }
            
            .video-container {
                padding: 10px;
                min-height: 200px;
            }
            
            video {
                border-radius: 6px;
            }
            
            .control-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            button {
                padding: 10px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è Escritorio Remoto - WebRTC</h1>
        
        <div id="firebaseWarning" class="info" style="margin-bottom: 20px; display: none;">
            <strong>‚öôÔ∏è Configuraci√≥n necesaria:</strong> Se est√° usando modo local (sin Firebase). 
            <a href="https://github.com/jv-pa7/jv-pa7.github.io#configurar-firebase" style="color: #667eea; text-decoration: underline;">Ver instrucciones</a> 
            para habilitar acceso multidispositivo.
        </div>
        
        <div id="roleSelection" class="section">
            <h2>¬øQu√© quieres hacer?</h2>
            <div class="input-group">
                <button onclick="selectRole('sharer')" style="flex: 1;">üñ•Ô∏è Compartir pantalla/c√°mara</button>
                <button onclick="selectRole('viewer')" style="flex: 1;">üëÅÔ∏è Ver pantalla remota</button>
            </div>
        </div>

        <div id="sharerSection" class="section" style="display: none;">
            <h2>Compartir tu pantalla/c√°mara</h2>
            <p>1. Ingresa tu nombre</p>
            <p>2. Haz clic para compartir</p>
            <p>3. Comparte el ID de la sala con otros</p>
            <div class="input-group">
                <input type="text" id="sharername" placeholder="Tu nombre">
                <button onclick="startScreenShare()" id="shareBtn">Compartir pantalla</button>
            </div>
            <div id="shareStatus" class="status"></div>
            <div id="mobileInfo" style="display: none; background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px;">
                <strong>üì± Consejo para m√≥viles:</strong> Usa la c√°mara trasera para mejor calidad. Aseg√∫rate de tener buena iluminaci√≥n.
            </div>
            <button onclick="backToRole()" style="margin-top: 20px; background: #999;">‚Üê Volver</button>
        </div>

        <div id="viewerSection" class="section" style="display: none;">
            <h2>Ver pantalla remota</h2>
            <p>1. Ingresa tu nombre</p>
            <p>2. Ingresa el ID de la sala</p>
            <p>3. Conecta autom√°ticamente</p>
            <div class="input-group">
                <input type="text" id="viewerName" placeholder="Tu nombre">
                <input type="text" id="roomId" placeholder="ID de la sala (ej: ROOM123ABC)">
                <button onclick="connectAsViewer()" id="connectBtn">Conectar</button>
            </div>
            <div id="joinStatus" class="status"></div>
            <button onclick="backToRole()" style="margin-top: 20px; background: #999;">‚Üê Volver</button>
        </div>

        <div class="video-container" id="videoContainer">
            <div id="sharerInfo" style="display: none; position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 12px 20px; border-radius: 8px; z-index: 10; font-weight: bold;">
                üé§ Compartiendo: <span id="sharerName">-</span>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
            <div id="localVideoContainer" style="display: none;">
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
        </div>

        <div id="connectionInfo" class="connection-info" style="display: none;">
            <strong>üìå ID de sala:</strong> <span id="currentRoomId" style="font-family: monospace; cursor: pointer;" onclick="copyRoomId()"></span>
            <small style="display: block; margin-top: 8px; cursor: pointer; color: #667eea;" onclick="copyRoomId()">Haz clic para copiar</small>
        </div>

        <div id="messages"></div>

        <div class="control-buttons" id="controlButtons" style="display: none;">
            <button onclick="toggleAudio()" id="audioBtn">Audio: Apagado</button>
            <button onclick="toggleVideo()" id="videoBtn">Video: Apagado</button>
            <button onclick="stopSharing()" id="stopBtn">Detener</button>
        </div>
    </div>

    <script>
        // üîÑ CONFIGURAR TU PROYECTO FIREBASE
        // Configuraci√≥n de webrdp
        
        const firebaseConfig = {
            apiKey: "AIzaSyAGqWW1KhV1f6N2LRfpNMsZjNWr_AQNN68",
            authDomain: "webrdp-4f0c6.firebaseapp.com",
            databaseURL: "https://webrdp-4f0c6-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webrdp-4f0c6",
            storageBucket: "webrdp-4f0c6.firebasestorage.app",
            messagingSenderId: "1032485952223",
            appId: "1:1032485952223:web:9b69ed418f1ea8446f676a",
            measurementId: "G-0SQGFF6H2K"
        };

        // Inicializar Firebase - Esperar a que las librer√≠as carguen
        let db = null;
        
        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error('‚ùå Firebase SDK no cargado');
                    return false;
                }
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('‚úÖ App Firebase inicializada');
                }
                
                if (typeof firebase.database !== 'function') {
                    console.error('‚ùå Firebase Database no disponible');
                    return false;
                }
                
                db = firebase.database();
                console.log('‚úÖ Base de datos Firebase conectada');
                console.log('üìä URL:', firebaseConfig.databaseURL);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error al inicializar Firebase:', error.message);
                console.error('Detalles:', error);
                return false;
            }
        }
        
        // Intentar inicializar ahora
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initializeFirebase, 500);
            });
        } else {
            setTimeout(initializeFirebase, 500);
        }
        
        // Si Firebase no inicializa, intentar de nuevo
        setTimeout(() => {
            if (!db) {
                console.warn('‚ö†Ô∏è Reintentando inicializaci√≥n de Firebase...');
                initializeFirebase();
            } else {
                // Firebase inicializ√≥ correctamente, ocultar advertencia
                document.getElementById('firebaseWarning').style.display = 'none';
                console.log('üî• Firebase listo para usar');
            }
        }, 2000);

        // Como √∫ltimo recurso, mostrar advertencia si Firebase no est√° disponible
        setTimeout(() => {
            if (!db) {
                document.getElementById('firebaseWarning').style.display = 'block';
                console.error('‚ùå Firebase no disponible, usando localStorage');
            }
        }, 4000);

        let localStream = null;
        let sharerPeerConnection = null;
        let viewerPeerConnection = null;
        let currentRoomId = null;
        let isAudioEnabled = true;
        let isVideoEnabled = true;
        let currentRole = null;
        let roomRef = null;
        let iceCandidatesRef = null;
        let remoteIceCandidatesRef = null;
        let statsIntervalRef = null;

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ],
            sdpSemantics: 'unified-plan'
        };

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        const mobileConfig = {
            video: {
                width: { ideal: 480 },
                height: { ideal: 320 },
                frameRate: { ideal: 15, max: 30 }
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        };

        // Generar ID de sala aleatorio
        function generateRoomId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'ROOM';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Copiar ID de sala al portapapeles
        function copyRoomId() {
            if (currentRoomId) {
                navigator.clipboard.writeText(currentRoomId);
                showMessage('‚úÖ ID de sala copiado al portapapeles', 'success');
            }
        }

        // Seleccionar rol
        function selectRole(role) {
            currentRole = role;
            document.getElementById('roleSelection').style.display = 'none';
            
            if (role === 'sharer') {
                document.getElementById('sharerSection').style.display = 'block';
                if (isMobile) {
                    document.getElementById('mobileInfo').style.display = 'block';
                }
            } else {
                document.getElementById('viewerSection').style.display = 'block';
            }
        }

        // Volver al inicio
        function backToRole() {
            currentRole = null;
            // Primero limpiar recursos (sin llamar a backToRole)
            cleanupConnection();
            // Luego resetear UI
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('sharerSection').style.display = 'none';
            document.getElementById('viewerSection').style.display = 'none';
        }

        // Limpiar recursos de conexi√≥n
        function cleanupConnection() {
            if (sharerPeerConnection) {
                sharerPeerConnection.close();
                sharerPeerConnection = null;
            }
            
            if (viewerPeerConnection) {
                viewerPeerConnection.close();
                viewerPeerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Limpiar en Firebase o localStorage
            if (currentRoomId) {
                if (db && roomRef) {
                    db.ref(`rooms/${currentRoomId}`).remove().catch(err => {
                        console.warn('Error limpiando Firebase:', err);
                        localStorage.removeItem(`webrtc_room_${currentRoomId}`);
                    });
                    roomRef.off('value');
                    roomRef = null;
                                    if (iceCandidatesRef) {
                                        iceCandidatesRef.off('child_added');
                                        iceCandidatesRef = null;
                                    }
                                    if (remoteIceCandidatesRef) {
                                        remoteIceCandidatesRef.off('child_added');
                                        remoteIceCandidatesRef = null;
                                    }
                                    if (statsIntervalRef) {
                                        clearInterval(statsIntervalRef);
                                        statsIntervalRef = null;
                                    }
                } else {
                    localStorage.removeItem(`webrtc_room_${currentRoomId}`);
                }
                currentRoomId = null;
            }
        }

        // Compartir pantalla
        async function startScreenShare() {
            try {
                const userName = document.getElementById('sharername').value.trim();
                if (!userName) {
                    showMessage('‚ö†Ô∏è Por favor ingresa tu nombre', 'error');
                    return;
                }

                // Obtener stream
                if (isMobile) {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: mobileConfig.video,
                        audio: mobileConfig.audio
                    });
                    showMessage('üì± Compartiendo c√°mara en m√≥vil', 'success');
                } else {
                    showMessage('üñ•Ô∏è Selecciona la pantalla a compartir y haz clic en "Compartir"', 'info');
                    localStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: true, 
                        audio: false 
                    });
                    showMessage('üñ•Ô∏è Compartiendo pantalla', 'success');
                }

                // Mostrar video local
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                document.getElementById('localVideoContainer').style.display = 'block';
                console.log('üìπ Video local capturado:', {videoTracks: localStream.getVideoTracks().length, audioTracks: localStream.getAudioTracks().length});

                // Crear peer connection para compartidor
                sharerPeerConnection = new RTCPeerConnection(configuration);
                
                sharerPeerConnection.addEventListener('signalingstatechange', () => {
                    console.log('[COMPARTIDOR] signalingState:', sharerPeerConnection.signalingState);
                });

                sharerPeerConnection.addEventListener('connectionstatechange', () => {
                    console.log('[COMPARTIDOR] connectionState:', sharerPeerConnection.connectionState);
                });
                
                localStream.getTracks().forEach((track, idx) => {
                    console.log(`[COMPARTIDOR] Agregando track ${idx}:`, track.kind, 'enabled:', track.enabled);
                    sharerPeerConnection.addTrack(track, localStream);
                });

                // Manejador de ICE candidates del compartidor
                sharerPeerConnection.addEventListener('icecandidate', (event) => {
                    if (event.candidate && currentRoomId && db) {
                        console.log('üì§ Enviando ICE candidate del compartidor:', event.candidate.candidate.substring(0, 50));
                        db.ref(`rooms/${currentRoomId}/sharerCandidates`).push(event.candidate);
                    }
                });

                // Crear oferta
                const offer = await sharerPeerConnection.createOffer();
                await sharerPeerConnection.setLocalDescription(offer);

                currentRoomId = generateRoomId();
                
                // Guardar datos en Firebase o localStorage
                const roomData = {
                    roomId: currentRoomId,
                    sharerName: userName,
                    offer: {
                        type: sharerPeerConnection.localDescription.type,
                        sdp: sharerPeerConnection.localDescription.sdp
                    },
                    timestamp: Date.now(),
                    status: 'waiting'
                };

                if (db) {
                    // Usar Firebase
                    roomRef = db.ref(`rooms/${currentRoomId}`);
                    await roomRef.set(roomData).catch(err => {
                        console.warn('Firebase error, using localStorage:', err);
                        localStorage.setItem(`webrtc_room_${currentRoomId}`, JSON.stringify(roomData));
                    });
                } else {
                    // Usar localStorage como fallback
                    localStorage.setItem(`webrtc_room_${currentRoomId}`, JSON.stringify(roomData));
                }
                
                document.getElementById('currentRoomId').textContent = currentRoomId;
                document.getElementById('connectionInfo').style.display = 'block';
                document.getElementById('controlButtons').style.display = 'flex';
                
                showMessage(`‚úÖ Sala creada: ${currentRoomId}`, 'success');
                showMessage('üë• Comparte este ID con otros para que se conecten', 'info');
                
                document.getElementById('shareBtn').textContent = 'Compartiendo...';
                document.getElementById('shareBtn').disabled = true;
                document.getElementById('sharername').disabled = true;

                // Escuchar respuestas del espectador
                listenForViewerResponse(currentRoomId);
                
                console.log('Compartiendo en sala:', currentRoomId);
                
            } catch (error) {
                console.error('Error al compartir:', error);
                showMessage(`‚ùå Error: ${error.message}`, 'error');
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
            }
        }

        // Escuchar respuesta del espectador
        function listenForViewerResponse(roomId) {
            if (db && roomRef) {
                // Usar Firebase
                roomRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.answer && sharerPeerConnection) {
                        try {
                            // Validar estructura de answer
                            if (!data.answer.type || !data.answer.sdp) {
                                console.warn('Answer inv√°lida:', data.answer);
                                return;
                            }
                            sharerPeerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                            showMessage('‚úÖ ¬°Espectador conectado! Video transmitiendo...', 'success');
                            console.log('‚úÖ [COMPARTIDOR] Answer recibida del espectador, transmitiendo...');
                            roomRef.off('value'); // Dejar de escuchar
                            
                            // Iniciar polling de stats en el compartidor
                            if (!statsIntervalRef) {
                                statsIntervalRef = setInterval(async () => {
                                    try {
                                        const stats = await sharerPeerConnection.getStats();
                                        stats.forEach(report => {
                                            if (report.type === 'outbound-rtp' && report.kind === 'video') {
                                                console.log('‚úÖ STATS SHARER outbound-rtp video:', {bytesSent: report.bytesSent, framesSent: report.framesSent});
                                            }
                                        });
                                    } catch (err) {
                                        console.warn('Error reading sharer stats:', err);
                                    }
                                }, 2000);
                            }
                            
                                                    // Escuchar ICE candidates del espectador
                                                    if (!remoteIceCandidatesRef) {
                                                        remoteIceCandidatesRef = db.ref(`rooms/${roomId}/viewerCandidates`);
                                                        remoteIceCandidatesRef.on('child_added', (snapshot) => {
                                                            const candidate = snapshot.val();
                                                            if (candidate && sharerPeerConnection) {
                                                                sharerPeerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(err => {
                                                                    console.warn('Error adding ICE candidate:', err);
                                                                });
                                                                console.log('üì• ICE candidate del espectador agregado');
                                                            }
                                                        });
                                                    }
                        } catch (error) {
                            console.error('Error al establecer respuesta:', error);
                        }
                    }
                });
            } else {
                // Fallback con localStorage
                const checkInterval = setInterval(() => {
                    const roomData = localStorage.getItem(`webrtc_room_${roomId}`);
                    if (roomData) {
                        const data = JSON.parse(roomData);
                        if (data && data.answer && sharerPeerConnection) {
                            clearInterval(checkInterval);
                            try {
                                // Validar estructura de answer
                                if (!data.answer.type || !data.answer.sdp) {
                                    console.warn('Answer inv√°lida:', data.answer);
                                    return;
                                }
                                sharerPeerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                                showMessage('‚úÖ ¬°Espectador conectado! Video transmitiendo...', 'success');
                                console.log('Espectador conectado v√≠a localStorage');
                            } catch (error) {
                                console.error('Error al establecer respuesta:', error);
                            }
                        }
                    }
                }, 500);

                setTimeout(() => clearInterval(checkInterval), 300000);
            }
        }

        // Conectar como espectador
        async function connectAsViewer() {
            try {
                const viewerName = document.getElementById('viewerName').value.trim();
                const roomId = document.getElementById('roomId').value.trim().toUpperCase();
                
                if (!viewerName) {
                    showMessage('‚ö†Ô∏è Por favor ingresa tu nombre', 'error');
                    return;
                }
                
                if (!roomId) {
                    showMessage('‚ö†Ô∏è Por favor ingresa el ID de la sala', 'error');
                    return;
                }

                // Obtener datos de la sala desde Firebase o localStorage
                let roomData = null;

                if (db) {
                    // Intentar obtener desde Firebase (usando once para Firebase 8.x)
                    const snapshot = await db.ref(`rooms/${roomId}`).once('value');
                    if (snapshot.exists()) {
                        roomData = snapshot.val();
                    }
                } else {
                    // Fallback a localStorage
                    const localData = localStorage.getItem(`webrtc_room_${roomId}`);
                    if (localData) {
                        roomData = JSON.parse(localData);
                    }
                }

                if (!roomData) {
                    showMessage(`‚ùå No se encontr√≥ la sala: ${roomId}`, 'error');
                    return;
                }

                const remoteOffer = roomData.offer;

                // Validar que el offer tiene la estructura correcta
                if (!remoteOffer || !remoteOffer.type || !remoteOffer.sdp) {
                    showMessage(`‚ùå La oferta de la sala es inv√°lida`, 'error');
                    console.error('Oferta inv√°lida:', remoteOffer);
                    return;
                }

                // Mostrar nombre del compartidor
                document.getElementById('sharerName').textContent = roomData.sharerName;
                document.getElementById('sharerInfo').style.display = 'block';

                // Crear peer connection para espectador
                viewerPeerConnection = new RTCPeerConnection(configuration);
                
                // Crear MediaStream ANTES de recibir tracks
                const remoteStream = new MediaStream();
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = remoteStream;
                // Mutear para permitir autoplay en la mayor√≠a de navegadores
                remoteVideo.muted = true;
                // Mostrar controles para depuraci√≥n (puede quitarse en producci√≥n)
                remoteVideo.controls = true;
                console.log('üìπ MediaStream remoto creado (muted, controls)');
                // A√±adir listeners de depuraci√≥n
                remoteVideo.addEventListener('loadedmetadata', () => {
                    console.log('remoteVideo loadedmetadata', remoteVideo.videoWidth, remoteVideo.videoHeight, 'readyState', remoteVideo.readyState);
                });
                remoteVideo.addEventListener('playing', () => {
                    console.log('remoteVideo playing ‚Äî tracks:', remoteStream.getTracks().map(t=>t.kind));
                });
                // A√±adir borde para verificar visibilidad (depuraci√≥n)
                remoteVideo.style.outline = '2px solid rgba(255,0,0,0.6)';
                
                viewerPeerConnection.addEventListener('signalingstatechange', () => {
                    console.log('[ESPECTADOR] signalingState:', viewerPeerConnection.signalingState);
                });

                viewerPeerConnection.addEventListener('track', (event) => {
                    console.log('Track remoto recibido:', event.track.kind);
                    const track = event.track;
                    remoteStream.addTrack(track);
                    console.log('‚úÖ Track a√±adido al stream remoto ‚Äî tipo:', track.kind, 'videoTracks:', remoteStream.getVideoTracks().length, 'audioTracks:', remoteStream.getAudioTracks().length);

                    // Eventos del track para diagn√≥stico
                    track.onunmute = () => console.log('track.onunmute:', track.kind);
                    track.onmute = () => console.log('track.onmute:', track.kind);
                    track.onended = () => console.log('track.onended:', track.kind);

                    // Forzar play y re-asignar srcObject para asegurar render
                    try {
                        remoteVideo.srcObject = remoteStream;
                        remoteVideo.play().catch(err => console.warn('play() fall√≥:', err));
                    } catch (e) {
                        console.warn('Error forzando play/re-assign:', e);
                    }

                    // Iniciar polling de stats para diagnosticar flujo de datos
                    if (viewerPeerConnection && !statsIntervalRef) {
                        statsIntervalRef = setInterval(async () => {
                            try {
                                const stats = await viewerPeerConnection.getStats();
                                let reportTypes = {};
                                stats.forEach(report => {
                                    reportTypes[report.type] = (reportTypes[report.type] || 0) + 1;
                                    if (report.type === 'inbound-rtp' && report.kind === 'video') {
                                        console.log('‚úÖ STATS inbound-rtp video:', {bytesReceived: report.bytesReceived, packetsLost: report.packetsLost, framesDecoded: report.framesDecoded});
                                    } else if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                        console.log('‚úÖ STATS candidate-pair succeeded:', {currentRoundTripTime: report.currentRoundTripTime, availableOutgoingBitrate: report.availableOutgoingBitrate});
                                    } else if (report.type === 'inbound-rtp' && report.kind === 'audio') {
                                        console.log('‚úÖ STATS inbound-rtp audio:', {bytesReceived: report.bytesReceived});
                                    }
                                });
                                if (Object.keys(reportTypes).length > 0) {
                                    console.log('üìä Tipos de report:', reportTypes);
                                }
                            } catch (err) {
                                console.warn('Error reading stats:', err);
                            }
                        }, 2000);
                    }
                    // Intentar reproducir el video cuando llegue el primer track
                    try {
                        if (remoteVideo.paused) {
                            remoteVideo.play().catch(err => console.warn('play() fall√≥:', err));
                        }
                    } catch (e) {
                        console.warn('Error intentando reproducir remoteVideo:', e);
                    }
                });

                viewerPeerConnection.addEventListener('connectionstatechange', () => {
                    console.log('[ESPECTADOR] connectionState:', viewerPeerConnection.connectionState);
                });

                // Manejador de ICE candidates del espectador
                viewerPeerConnection.addEventListener('icecandidate', (event) => {
                    if (event.candidate && roomId && db) {
                        console.log('üì§ Enviando ICE candidate del espectador:', event.candidate.candidate.substring(0, 50));
                        db.ref(`rooms/${roomId}/viewerCandidates`).push(event.candidate);
                    }
                });

                // Establecer oferta remota
                await viewerPeerConnection.setRemoteDescription(new RTCSessionDescription(remoteOffer));

                // Asegurar que estamos en el estado correcto antes de crear la answer
                if (viewerPeerConnection.signalingState !== 'have-remote-offer') {
                    await new Promise((resolve) => {
                        const onState = () => {
                            if (viewerPeerConnection.signalingState === 'have-remote-offer') {
                                viewerPeerConnection.removeEventListener('signalingstatechange', onState);
                                resolve();
                            }
                        };
                        viewerPeerConnection.addEventListener('signalingstatechange', onState);
                        // peque√±a salvaguarda: resolver tras 2s aunque no cambie (evita bloqueo)
                        setTimeout(() => {
                            viewerPeerConnection.removeEventListener('signalingstatechange', onState);
                            resolve();
                        }, 2000);
                    });
                }

                // Crear respuesta
                const answer = await viewerPeerConnection.createAnswer();
                // Intentar setLocalDescription con reintento si el estado no es el esperado
                try {
                    await viewerPeerConnection.setLocalDescription(answer);
                } catch (err) {
                    console.warn('setLocalDescription fall√≥ primero, reintentando:', err);
                    // Si falla por estado, esperar un momento y reintentar
                    await new Promise(r => setTimeout(r, 200));
                    try {
                        await viewerPeerConnection.setLocalDescription(answer);
                    } catch (err2) {
                        console.error('setLocalDescription sigue fallando:', err2);
                        throw err2;
                    }
                }

                // Escuchar ICE candidates del compartidor
                if (db && !iceCandidatesRef) {
                    iceCandidatesRef = db.ref(`rooms/${roomId}/sharerCandidates`);
                    iceCandidatesRef.on('child_added', (snapshot) => {
                        const candidate = snapshot.val();
                        if (candidate && viewerPeerConnection) {
                            viewerPeerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(err => {
                                console.warn('Error adding ICE candidate:', err);
                            });
                            console.log('üì• ICE candidate del compartidor agregado');
                        }
                    });
                }

                // Guardar respuesta en Firebase o localStorage
                roomData.answer = {
                    type: viewerPeerConnection.localDescription.type,
                    sdp: viewerPeerConnection.localDescription.sdp
                };
                roomData.viewerName = viewerName;
                roomData.status = 'connected';

                if (db) {
                    // Usar Firebase
                    await new Promise((resolve, reject) => {
                        db.ref(`rooms/${roomId}`).update(roomData, (error) => {
                            if (error) {
                                console.warn('Firebase error, using localStorage:', error);
                                localStorage.setItem(`webrtc_room_${roomId}`, JSON.stringify(roomData));
                            }
                            resolve();
                        });
                    });
                } else {
                    // Usar localStorage
                    localStorage.setItem(`webrtc_room_${roomId}`, JSON.stringify(roomData));
                }
                
                currentRoomId = roomId;
                showMessage('‚úÖ ¬°Conectado! Recibiendo transmisi√≥n...', 'success');
                console.log('Espectador conectado a sala:', roomId);
                
                document.getElementById('viewerName').disabled = true;
                document.getElementById('roomId').disabled = true;
                document.getElementById('connectBtn').disabled = true;
                
            } catch (error) {
                console.error('Error al conectar:', error);
                showMessage(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function toggleAudio() {
            if (localStream) {
                isAudioEnabled = !isAudioEnabled;
                localStream.getAudioTracks().forEach(track => track.enabled = isAudioEnabled);
                document.getElementById('audioBtn').textContent = `Audio: ${isAudioEnabled ? 'Activado' : 'Desactivado'}`;
            }
        }

        function toggleVideo() {
            if (localStream) {
                isVideoEnabled = !isVideoEnabled;
                localStream.getVideoTracks().forEach(track => track.enabled = isVideoEnabled);
                document.getElementById('videoBtn').textContent = `Video: ${isVideoEnabled ? 'Activado' : 'Desactivado'}`;
            }
        }

        function stopSharing() {
            cleanupConnection();
            
            document.getElementById('shareBtn').textContent = 'Compartir pantalla';
            document.getElementById('shareBtn').disabled = false;
            document.getElementById('sharername').disabled = false;
            document.getElementById('controlButtons').style.display = 'none';
            document.getElementById('localVideoContainer').style.display = 'none';
            document.getElementById('connectionInfo').style.display = 'none';
            document.getElementById('sharerInfo').style.display = 'none';
            
            showMessage('üîå Compartici√≥n detenida', 'success');
            console.log('Compartici√≥n detenida');
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Verificaciones iniciales
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showMessage('‚ùå Tu navegador no soporta WebRTC', 'error');
            document.getElementById('shareBtn').disabled = true;
        }

        if (!navigator.mediaDevices.getDisplayMedia && !isMobile) {
            showMessage('‚ö†Ô∏è La compartici√≥n de pantalla no est√° disponible', 'error');
        }

        console.log('‚úÖ Aplicaci√≥n de escritorio remoto iniciada');
        console.log('Modo:', isMobile ? 'M√≥vil' : 'Escritorio');
        console.log('BD: Esperando inicializaci√≥n de Firebase...');
    </script>
</body>
</html>
